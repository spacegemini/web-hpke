<!DOCTYPE html>
<html lang="zh-CN">
<!-- i18n supported -->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">ECC/HPKE å¯†é’¥ç®¡ç†ä¸åŠ è§£å¯†å·¥å…·</title>
    <!-- SEO Meta Tags -->
    <meta name="description" content="åŸºäºæµè§ˆå™¨æœ¬åœ°è¿è¡Œçš„ ECC/HPKE å¯†é’¥ç”Ÿæˆä¸æ–‡ä»¶åŠ è§£å¯†å·¥å…·ã€‚å®‰å…¨ã€ç¦»çº¿ã€æ— éœ€ä¸Šä¼ ç§é’¥ã€‚æ”¯æŒ P-256 ç®—æ³•ã€‚">
    <meta name="keywords" content="ECC, HPKE, åœ¨çº¿åŠ å¯†, æ–‡ä»¶è§£å¯†, P-256, æµè§ˆå™¨åŠ å¯†, å®‰å…¨å·¥å…·, ç¦»çº¿ä½¿ç”¨, éšç§ä¿æŠ¤">
    <meta name="author" content="Start2025/M3U8-Downloader">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://start2025.github.io/hpke.html">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://start2025.github.io/hpke.html">
    <meta property="og:title" content="ECC/HPKE å¯†é’¥ç®¡ç†ä¸åŠ è§£å¯†å·¥å…·">
    <meta property="og:description" content="åŸºäºæµè§ˆå™¨æœ¬åœ°è¿è¡Œçš„ ECC/HPKE å¯†é’¥ç”Ÿæˆä¸æ–‡ä»¶åŠ è§£å¯†å·¥å…·ã€‚å®‰å…¨ã€ç¦»çº¿ã€æ— éœ€ä¸Šä¼ ç§é’¥ã€‚">
    <meta property="og:image" content="https://start2025.github.io/icon.png">

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image">
    <meta property="twitter:url" content="https://start2025.github.io/hpke.html">
    <meta property="twitter:title" content="ECC/HPKE å¯†é’¥ç®¡ç†ä¸åŠ è§£å¯†å·¥å…·">
    <meta property="twitter:description" content="åŸºäºæµè§ˆå™¨æœ¬åœ°è¿è¡Œçš„ ECC/HPKE å¯†é’¥ç”Ÿæˆä¸æ–‡ä»¶åŠ è§£å¯†å·¥å…·ã€‚å®‰å…¨ã€ç¦»çº¿ã€æ— éœ€ä¸Šä¼ ç§é’¥ã€‚">
    <meta property="twitter:image" content="https://start2025.github.io/icon.png">

    <!-- Structured Data (JSON-LD) -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "ECC/HPKE Encryption Tool",
      "url": "https://start2025.github.io/hpke.html",
      "description": "A client-side secure file encryption tool using ECC HPKE (P-256). No server upload required.",
      "applicationCategory": "SecurityApplication",
      "operatingSystem": "Any (Browser-based)",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "USD"
      },
      "featureList": "Generate ECC Key Pair, Encrypt Files, Decrypt Files, Offline Capable"
    }
    </script>

    <!-- PWA Settings -->
    <link rel="manifest" href="hpke_manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="theme-color" content="#007bff">
    <link rel="apple-touch-icon" href="./hpke_lib/icon-192.png">
    <style>
        body {
            font-family: -apple-system, sans-serif;
            background: #f0f2f5;
            padding: 20px;
            color: #333;
            line-height: 1.5;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }

        h2 {
            margin-top: 0;
            font-size: 1.25rem;
            color: #007bff;
            border-bottom: 2px solid #f0f0f0;
            padding-bottom: 10px;
        }

        label {
            display: block;
            margin: 15px 0 5px;
            font-weight: bold;
            font-size: 14px;
        }

        textarea,
        input {
            width: 100%;
            box-sizing: border-box;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-family: monospace;
            font-size: 13px;
        }

        textarea {
            height: 70px;
            resize: none;
            background: #fafafa;
        }

        .btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 15px;
            font-weight: bold;
            transition: 0.2s;
            margin-top: 10px;
        }

        .btn-gen {
            background: #28a745;
            color: white;
        }

        .btn-gen:hover {
            background: #218838;
        }

        .btn-dec {
            background: #007bff;
            color: white;
        }

        .btn-dec:hover {
            background: #0056b3;
        }

        .btn-enc {
            background: #673ab7;
            color: white;
        }

        .btn-enc:hover {
            background: #3d15dc;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            display: none;
            word-break: break-all;
        }

        .info {
            background: #e6f7ff;
            color: #1890ff;
            border: 1px solid #91d5ff;
            display: block;
        }

        .success {
            background: #f6ffed;
            color: #52c41a;
            border: 1px solid #b7eb8f;
            display: block;
        }

        .error {
            background: #fff1f0;
            color: #f5222d;
            border: 1px solid #ffa39e;
            display: block;
        }

        .tip {
            font-size: 12px;
            color: #888;
            margin-top: 5px;
        }

        .security-banner {
            background-color: #e8f5e9;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #c8e6c9;
            display: flex;
            align-items: center;
            font-size: 14px;
        }

        .security-banner svg {
            width: 24px;
            height: 24px;
            margin-right: 12px;
            fill: currentColor;
            flex-shrink: 0;
        }

        .action-bar {
            display: flex;
            gap: 10px;
            margin-top: 5px;
        }

        .btn-sm {
            flex: 1;
            padding: 8px;
            font-size: 13px;
            border: 1px solid #ced4da;
            background: #f8f9fa;
            color: #495057;
            border-radius: 4px;
            cursor: pointer;
            text-align: center;
            transition: all 0.2s;
        }

        .btn-sm:hover {
            background: #e2e6ea;
            border-color: #adb5bd;
        }

        /* Mobile Optimization */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }

            .card {
                padding: 15px;
            }

            h2 {
                font-size: 1.1rem;
            }

            .btn {
                padding: 14px;
                /* Larger touch target */
            }

            /* Prevent iOS zoom on inputs */
            textarea,
            input {
                font-size: 16px;
            }
        }

        /* Collapsible Cards */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
            padding-bottom: 10px;
            border-bottom: 2px solid #f0f0f0;
            margin-bottom: 15px;
        }

        .card-header h2 {
            margin: 0;
            border: none;
            padding: 0;
        }

        .toggle-icon {
            font-size: 1.2rem;
            color: #ccc;
            transition: transform 0.3s ease;
        }

        .card.collapsed .toggle-icon {
            transform: rotate(-90deg);
        }

        .card.collapsed .card-content {
            display: none;
        }

        /* Remove margin when collapsed to save space */
        .card.collapsed {
            padding-bottom: 15px;
        }

        .card.collapsed .card-header {
            margin-bottom: 0;
            border-bottom: none;
        }

        .warning-box {
            background-color: #fff1f0;
            border: 1px solid #ffa39e;
            color: #d81e06;
            padding: 10px;
            border-radius: 6px;
            font-size: 13px;
            margin: 15px 0;
            display: flex;
            align-items: center;
        }

        .warning-box svg {
            width: 18px;
            height: 18px;
            margin-right: 8px;
            fill: currentColor;
            flex-shrink: 0;
        }

        /* Sensitive Data Protection */
        .sensitive-blur {
            transition: filter 0.3s ease;
            cursor: pointer;
        }

        /* Blur only when content exists (not placeholder) and not revealed */
        .sensitive-blur:not(:placeholder-shown):not(.revealed) {
            filter: blur(8px);
            user-select: none;
        }

        .sensitive-blur:not(:placeholder-shown):not(.revealed):hover {
            filter: blur(5px);
        }
    </style>
</head>

<body>

    <div class="container">
        <!-- Main Heading for SEO -->
        <h1 id="mainTitle" style="text-align: center; color: #007bff; margin-bottom: 20px;" data-i18n="pageMainHeading">
            ECC/HPKE å¯†é’¥ç®¡ç†ä¸åŠ è§£å¯†å·¥å…·</h1>
        <!-- Security Notice -->
        <div class="security-banner">
            <svg viewBox="0 0 24 24">
                <path
                    d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm0 10.99h7c-.53 4.12-3.28 7.79-7 8.94V12H5V6.3l7-3.11v8.8z" />
            </svg>
            <div>
                <strong data-i18n="securityTitle">å®‰å…¨æ‰¿è¯ºï¼š</strong> <br /><span
                    data-i18n="securityText">æœ¬å·¥å…·æ‰€æœ‰åŠ è§£å¯†è¿ç®—å‡åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°å®Œæˆï¼ˆClient-side Onlyï¼‰ã€‚
                    <br>æ‚¨çš„ç§é’¥å’Œæ–‡ä»¶æ°¸è¿œä¸ä¼šè¢«å‘é€åˆ°ä»»ä½•æœåŠ¡å™¨ã€‚<br>æ‚¨ç”šè‡³å¯ä»¥åœ¨æ–­ç½‘çŠ¶æ€ä¸‹ä½¿ç”¨æœ¬å·¥å…·ä»¥éªŒè¯å®‰å…¨æ€§ã€‚<br>æºç å®Œå…¨å…¬å¼€é€æ˜ï¼Œæ‚¨å¯åœ¨æµè§ˆå™¨è°ƒè¯•å·¥å…·ä¸­ç›´æ¥æŸ¥çœ‹ã€‚</span>
            </div>
        </div>

        <!-- PWA Install Button (Hidden by default) -->
        <button id="installBtn" class="btn" data-i18n="installBtn"
            style="display:none; background: #17a2b8; color: white; margin-bottom: 20px;">ğŸ“² æ·»åŠ åˆ°æ¡Œé¢ (Install
            App)</button>
        <!-- ä½¿ç”¨è¯´æ˜ -->
        <div class="card collapsed">
            <div class="card-header" onclick="toggleCard(this.parentElement)">
                <h2 data-i18n="manualTitle">ğŸ“Œ ä½¿ç”¨è¯´æ˜ (How to Use)</h2>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="card-content">
                <ol style="padding-left: 20px; line-height: 1.8;">
                    <li><strong data-i18n="step1Title">ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆå¯†é’¥ (Generate Key Pair)</strong><br>
                        <span data-i18n="step1Text">ç‚¹å‡»â€œç”Ÿæˆæ–°å¯†é’¥å¯¹â€ï¼Œæ‚¨å°†è·å¾—ä¸€æŠŠç§é’¥ï¼ˆç”¨äºè§£å¯†ï¼‰å’Œä¸€æŠŠå…¬é’¥ï¼ˆç”¨äºåŠ å¯†ï¼‰ã€‚è¯·åŠ¡å¿…ä¿å­˜å¥½æ‚¨çš„ç§é’¥ï¼Œä¸¢å¤±å³æ„å‘³ç€æ•°æ®æ°¸ä¹…ä¸¢å¤±ã€‚</span>
                    </li>
                    <li><strong data-i18n="step2Title">ç¬¬äºŒæ­¥ï¼šåŠ å¯†æ–‡ä»¶ (Encrypt File)</strong><br>
                        <span data-i18n="step2Text">å¦‚æœæ‚¨è¦å‘é€æ–‡ä»¶ç»™åˆ«äººï¼Œè¯·ç´¢è¦å¯¹æ–¹çš„å…¬é’¥ï¼Œå¡«å…¥â€œåŠ å¯†æ–‡ä»¶â€åŒºåŸŸï¼Œé€‰æ‹©æ–‡ä»¶åå³å¯ç”Ÿæˆ .hpke åŠ å¯†æ–‡ä»¶ã€‚</span>
                    </li>
                    <li><strong data-i18n="step3Title">ç¬¬ä¸‰æ­¥ï¼šè§£å¯†æ–‡ä»¶ (Decrypt File)</strong><br>
                        <span data-i18n="step3Text">å¦‚æœæ‚¨æ”¶åˆ°äº† .hpke æ–‡ä»¶ï¼Œè¯·åœ¨â€œæ–‡ä»¶å®‰å…¨è§£å¯†â€åŒºåŸŸå¡«å…¥æ‚¨è‡ªå·±çš„ç§é’¥ï¼Œä¸Šä¼ æ–‡ä»¶å³å¯è¿˜åŸåŸå§‹æ–‡ä»¶ã€‚</span>
                    </li>
                    <li><strong data-i18n="stepTextTitle">æ™®é€šæ–‡æœ¬åŠ è§£å¯†</strong><br>
                        <span data-i18n="stepTextDesc">æœ¬å·¥å…·åŒæ—¶ä¹Ÿæ”¯æŒå¯¹çº¯æ–‡æœ¬æ¶ˆæ¯è¿›è¡Œå¿«é€ŸåŠ å¯†å’Œè§£å¯†ï¼Œæµç¨‹åŒä¸Šã€‚</span>
                    </li>
                </ol>
                <div class="info" style="margin-top: 10px; padding: 10px; font-size: 13px;" data-i18n="tipText">
                    ğŸ’¡ å°è´´å£«ï¼šå…¬é’¥æ˜¯å¯ä»¥å…¬å¼€åˆ†äº«çš„ï¼Œè€Œç§é’¥å¿…é¡»è‡ªå·±ä¸¥å¯†ä¿ç®¡ã€‚
                </div>
            </div>
        </div>

        <!-- ç¬¬ä¸€éƒ¨åˆ†ï¼šå¯†é’¥ç”Ÿæˆ -->
        <div class="card collapsed">
            <div class="card-header" onclick="toggleCard(this.parentElement)">
                <h2 data-i18n="sec1Title">1. ç”Ÿæˆ ECC å¯†é’¥å¯¹ (HPKE P-256)</h2>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="card-content">
                <p class="tip" data-i18n="sec1Tip">åœ¨æœ¬åœ°ç”Ÿæˆå®‰å…¨çš„å¯†é’¥å¯¹ã€‚è¯·åŠ¡å¿…å¦¥å–„ä¿å­˜æ‚¨çš„ç§é’¥ï¼</p>

                <button class="btn btn-gen" id="genBtn" data-i18n="genBtn">ç”Ÿæˆæ–°å¯†é’¥å¯¹</button>

                <!-- Private Key Warning -->
                <div class="warning-box">
                    <svg viewBox="0 0 24 24">
                        <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z" />
                    </svg>
                    <span data-i18n="privWarning"><strong>è­¦å‘Šï¼š</strong> è¯·å‹¿å°†ç§é’¥å‘é€ç»™ä»»ä½•äººï¼æ‹¥æœ‰ç§é’¥çš„äººå¯ä»¥è§£å¯†æ‚¨çš„æ‰€æœ‰æ–‡ä»¶å’Œæ¶ˆæ¯ã€‚</span>
                </div>

                <label data-i18n="labelPriv">æ‚¨çš„ç§é’¥ (Private Key - è¯·ä¿å¯†, ä¸¢å¤±æ— æ³•è§£å¯†):</label>
                <textarea id="outPriv" class="sensitive-blur" readonly data-i18n-title="toggleBlurTitle"
                    data-i18n-ph="phPriv" placeholder="ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆ..."></textarea>
                <div class="action-bar">
                    <button class="btn-sm" id="copyPrivBtn" data-i18n="btnCopyPriv">ğŸ“„ å¤åˆ¶ç§é’¥</button>
                    <button class="btn-sm" id="savePrivBtn" data-i18n="btnSavePriv">ğŸ’¾ ä¿å­˜ç§é’¥</button>
                </div>

                <label data-i18n="labelPub">æ‚¨çš„å…¬é’¥ (Public Key - å‘ç»™åŠ å¯†æ–¹):</label>
                <textarea id="outPub" readonly data-i18n-ph="phPub" placeholder="ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆ..."></textarea>
                <div class="action-bar">
                    <button class="btn-sm" id="copyPubBtn" data-i18n="btnCopyPub">ğŸ“„ å¤åˆ¶å…¬é’¥</button>
                    <button class="btn-sm" id="savePubBtn" data-i18n="btnSavePub">ğŸ’¾ ä¿å­˜å…¬é’¥</button>
                </div>
            </div>
        </div>

        <!-- ç¬¬äºŒéƒ¨åˆ†ï¼šè§£å¯†æ–‡ä»¶åŠŸèƒ½ -->
        <div class="card collapsed">
            <div class="card-header" onclick="toggleCard(this.parentElement)">
                <h2 data-i18n="sec2Title">2. æ–‡ä»¶å®‰å…¨è§£å¯†</h2>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="card-content">
                <label data-i18n="labelInputPriv">è¾“å…¥ç§é’¥ (Hex):</label>
                <textarea id="decryptPriv" class="sensitive-blur" data-i18n-title="toggleBlurTitle"
                    data-i18n-ph="phInputPriv" placeholder="ç²˜è´´æ‚¨çš„ç§é’¥è¿›è¡Œè§£å¯†..."></textarea>

                <label data-i18n="labelInputFile">é€‰æ‹©åŠ å¯†æ–‡ä»¶ (.hpke):</label>
                <input type="file" id="fileInput" />

                <button class="btn btn-dec" id="decBtn" data-i18n="btnDec">å®‰å…¨è§£å¯†å¹¶ä¸‹è½½</button>

                <div id="decStatus" class="status"></div>
            </div>
        </div>

        <!-- ç¬¬ä¸‰éƒ¨åˆ†. æ–‡ä»¶åŠ å¯†åŠŸèƒ½ -->
        <div class="card collapsed">
            <div class="card-header" onclick="toggleCard(this.parentElement)">
                <h2 data-i18n="sec3Title">3. åŠ å¯†æ–‡ä»¶ (å‘é€è€…)</h2>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="card-content">
                <label data-i18n="labelInputPub">æ¥æ”¶è€…çš„å…¬é’¥ (Hex):</label>
                <textarea id="encryptPub" data-i18n-ph="phInputPub" placeholder="åœ¨æ­¤ç²˜è´´æ¥æ”¶è€…çš„å…¬é’¥..."></textarea>

                <label data-i18n="labelOrigFile">é€‰æ‹©åŸå§‹æ–‡ä»¶:</label>
                <!-- <input type="file" id="encryptFile" accept="image/*" /> -->
                <input type="file" id="encryptFile" />

                <button class="btn btn-enc" id="encBtn" data-i18n="btnEnc">åŠ å¯†å¹¶ä¸‹è½½ .hpke æ–‡ä»¶</button>
                <div id="encStatus" class="status"></div>
            </div>
        </div>

        <!-- ç¬¬å››éƒ¨åˆ†ï¼šæ–‡æœ¬åŠ å¯† -->
        <div class="card collapsed">
            <div class="card-header" onclick="toggleCard(this.parentElement)">
                <h2 data-i18n="sec4Title">4. æ–‡æœ¬æ¶ˆæ¯åŠ å¯†</h2>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="card-content">
                <label data-i18n="labelInputPub">æ¥æ”¶è€…çš„å…¬é’¥ (Hex):</label>
                <textarea id="textEncPub" data-i18n-ph="phMsgPub" placeholder="åœ¨æ­¤ç²˜è´´æ¥æ”¶è€…çš„å…¬é’¥..."></textarea>

                <label data-i18n="labelMsgPlain">åŸå§‹æ¶ˆæ¯:</label>
                <textarea id="textPlain" data-i18n-ph="phMsgPlain" placeholder="è¾“å…¥è¦åŠ å¯†çš„æ–‡æœ¬æ¶ˆæ¯..."></textarea>

                <button class="btn btn-enc" id="textEncBtn" data-i18n="btnTextEnc">åŠ å¯†æ–‡æœ¬</button>

                <label data-i18n="labelMsgCipher">åŠ å¯†ç»“æœ (Base64):</label>
                <textarea id="textCipher" readonly data-i18n-ph="phMsgCipher" placeholder="åŠ å¯†åçš„å¯†æ–‡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
                <div class="action-bar">
                    <button class="btn-sm" id="copyTextCipherBtn" data-i18n="btnCopyCipher">ğŸ“„ å¤åˆ¶å¯†æ–‡</button>
                </div>
            </div>
        </div>

        <!-- ç¬¬äº”éƒ¨åˆ†ï¼šæ–‡æœ¬è§£å¯† -->
        <div class="card collapsed">
            <div class="card-header" onclick="toggleCard(this.parentElement)">
                <h2 data-i18n="sec5Title">5. æ–‡æœ¬æ¶ˆæ¯è§£å¯†</h2>
                <span class="toggle-icon">â–¼</span>
            </div>
            <div class="card-content">
                <label data-i18n="labelInputPriv">è¾“å…¥ç§é’¥ (Hex):</label>
                <textarea id="textDecPriv" class="sensitive-blur" data-i18n-title="toggleBlurTitle"
                    data-i18n-ph="phDecPriv" placeholder="ç²˜è´´æ‚¨çš„ç§é’¥..."></textarea>

                <label data-i18n="labelMsgInCipher">åŠ å¯†æ¶ˆæ¯ (Base64):</label>
                <textarea id="textInputCipher" data-i18n-ph="phMsgInCipher" placeholder="ç²˜è´´æ”¶åˆ°çš„åŠ å¯†å¯†æ–‡..."></textarea>

                <button class="btn btn-dec" id="textDecBtn" data-i18n="btnTextDec">è§£å¯†æ–‡æœ¬</button>

                <label data-i18n="labelDecResult">è§£å¯†ç»“æœ:</label>
                <textarea id="textOutputPlain" readonly data-i18n-ph="phDecResult"
                    placeholder="è§£å¯†åçš„æ¶ˆæ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
                <div class="action-bar">
                    <button class="btn-sm" id="copyTextPlainBtn" data-i18n="btnCopyPlain">ğŸ“„ å¤åˆ¶åŸæ–‡</button>
                </div>
            </div>
        </div>
    </div>

    <!-- UI Logic & Detection (Safe for older browsers) -->
    <script>
        // --- Global Error Handler which alerts user ---
        window.onerror = function (msg, url, line, col, error) {
            // Ignore trivial resizing errors or others if needed
            // But if the crypto module fails, we might see it here
        };

        // --- Compatibility Check ---
        function checkCompatibility() {
            const warnings = [];
            if (typeof BigInt === 'undefined') {
                warnings.push("Your browser does not support BigInt (iOS < 14?). Encryption functions will likely fail.");
            }
            if (warnings.length > 0) {
                const warnBox = document.createElement('div');
                warnBox.className = 'warning-box';
                warnBox.style.margin = '20px 0';
                warnBox.innerHTML = `<strong>âš ï¸ Compatibility Warning:</strong><br>${warnings.join('<br>')}`;
                const container = document.querySelector('.container');
                if (container) container.prepend(warnBox);
            }
        }

        // --- I18N Logic (Moved to Global) ---
        const i18nData = {
            "zh": {
                "pageTitle": "ECC/HPKE å¯†é’¥ç®¡ç†ä¸åŠ è§£å¯†å·¥å…· - æœ¬åœ°å®‰å…¨åŠ è§£å¯†",
                "pageMainHeading": "ECC/HPKE å¯†é’¥ç®¡ç†ä¸åŠ è§£å¯†å·¥å…·",
                "pageDescription": "åŸºäºæµè§ˆå™¨æœ¬åœ°è¿è¡Œçš„ ECC/HPKE å¯†é’¥ç”Ÿæˆä¸æ–‡ä»¶åŠ è§£å¯†å·¥å…·ã€‚å®‰å…¨ã€ç¦»çº¿ã€æ— éœ€ä¸Šä¼ ç§é’¥ã€‚æ”¯æŒ P-256 ç®—æ³•ã€‚",
                "pageKeywords": "ECC, HPKE, åœ¨çº¿åŠ å¯†, æ–‡ä»¶è§£å¯†, P-256, æµè§ˆå™¨åŠ å¯†, å®‰å…¨å·¥å…·, ç¦»çº¿ä½¿ç”¨, éšç§ä¿æŠ¤",
                "securityTitle": "å®‰å…¨æ‰¿è¯ºï¼š",
                "securityText": "æœ¬å·¥å…·æ‰€æœ‰åŠ è§£å¯†è¿ç®—å‡åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°å®Œæˆï¼ˆClient-side Onlyï¼‰ã€‚<br>æ‚¨çš„ç§é’¥å’Œæ–‡ä»¶æ°¸è¿œä¸ä¼šè¢«å‘é€åˆ°ä»»ä½•æœåŠ¡å™¨ã€‚<br>æ‚¨ç”šè‡³å¯ä»¥åœ¨æ–­ç½‘çŠ¶æ€ä¸‹ä½¿ç”¨æœ¬å·¥å…·ä»¥éªŒè¯å®‰å…¨æ€§ã€‚<br>æºç å®Œå…¨å…¬å¼€é€æ˜ï¼Œæ‚¨å¯åœ¨æµè§ˆå™¨è°ƒè¯•å·¥å…·ä¸­ç›´æ¥æŸ¥çœ‹ã€‚",
                "installBtn": "ğŸ“² æ·»åŠ åˆ°æ¡Œé¢ (Install App)",
                "manualTitle": "ğŸ“Œ ä½¿ç”¨è¯´æ˜ (How to Use)",
                "step1Title": "ç¬¬ä¸€æ­¥ï¼šç”Ÿæˆå¯†é’¥ (Generate Key Pair)",
                "step1Text": "ç‚¹å‡»â€œç”Ÿæˆæ–°å¯†é’¥å¯¹â€ï¼Œæ‚¨å°†è·å¾—ä¸€æŠŠç§é’¥ï¼ˆç”¨äºè§£å¯†ï¼‰å’Œä¸€æŠŠå…¬é’¥ï¼ˆç”¨äºåŠ å¯†ï¼‰ã€‚è¯·åŠ¡å¿…ä¿å­˜å¥½æ‚¨çš„ç§é’¥ï¼Œä¸¢å¤±å³æ„å‘³ç€æ•°æ®æ°¸ä¹…ä¸¢å¤±ã€‚",
                "step2Title": "ç¬¬äºŒæ­¥ï¼šåŠ å¯†æ–‡ä»¶ (Encrypt File)",
                "step2Text": "å¦‚æœæ‚¨è¦å‘é€æ–‡ä»¶ç»™åˆ«äººï¼Œè¯·ç´¢è¦å¯¹æ–¹çš„å…¬é’¥ï¼Œå¡«å…¥â€œåŠ å¯†æ–‡ä»¶â€åŒºåŸŸï¼Œé€‰æ‹©æ–‡ä»¶åå³å¯ç”Ÿæˆ .hpke åŠ å¯†æ–‡ä»¶ã€‚",
                "step3Title": "ç¬¬ä¸‰æ­¥ï¼šè§£å¯†æ–‡ä»¶ (Decrypt File)",
                "step3Text": "å¦‚æœæ‚¨æ”¶åˆ°äº† .hpke æ–‡ä»¶ï¼Œè¯·åœ¨â€œæ–‡ä»¶å®‰å…¨è§£å¯†â€åŒºåŸŸå¡«å…¥æ‚¨è‡ªå·±çš„ç§é’¥ï¼Œä¸Šä¼ æ–‡ä»¶å³å¯è¿˜åŸåŸå§‹æ–‡ä»¶ã€‚",
                "stepTextTitle": "æ™®é€šæ–‡æœ¬åŠ è§£å¯†",
                "stepTextDesc": "æœ¬å·¥å…·åŒæ—¶ä¹Ÿæ”¯æŒå¯¹çº¯æ–‡æœ¬æ¶ˆæ¯è¿›è¡Œå¿«é€ŸåŠ å¯†å’Œè§£å¯†ï¼Œæµç¨‹åŒä¸Šã€‚",
                "tipText": "ğŸ’¡ å°è´´å£«ï¼šå…¬é’¥æ˜¯å¯ä»¥å…¬å¼€åˆ†äº«çš„ï¼Œè€Œç§é’¥å¿…é¡»è‡ªå·±ä¸¥å¯†ä¿ç®¡ã€‚",
                "sec1Title": "1. ç”Ÿæˆ ECC å¯†é’¥å¯¹ (HPKE P-256)",
                "sec1Tip": "åœ¨æœ¬åœ°ç”Ÿæˆå®‰å…¨çš„å¯†é’¥å¯¹ã€‚è¯·åŠ¡å¿…å¦¥å–„ä¿å­˜æ‚¨çš„ç§é’¥ï¼",
                "genBtn": "ç”Ÿæˆæ–°å¯†é’¥å¯¹",
                "privWarning": "<strong>è­¦å‘Šï¼š</strong> è¯·å‹¿å°†ç§é’¥å‘é€ç»™ä»»ä½•äººï¼æ‹¥æœ‰ç§é’¥çš„äººå¯ä»¥è§£å¯†æ‚¨çš„æ‰€æœ‰æ–‡ä»¶å’Œæ¶ˆæ¯ã€‚",
                "labelPriv": "æ‚¨çš„ç§é’¥ (Private Key - è¯·ä¿å¯†, ä¸¢å¤±æ— æ³•è§£å¯†):",
                "phPriv": "ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆ...",
                "btnCopyPriv": "ğŸ“„ å¤åˆ¶ç§é’¥",
                "btnSavePriv": "ğŸ’¾ ä¿å­˜ç§é’¥",
                "labelPub": "æ‚¨çš„å…¬é’¥ (Public Key - å‘ç»™åŠ å¯†æ–¹):",
                "phPub": "ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ç”Ÿæˆ...",
                "btnCopyPub": "ğŸ“„ å¤åˆ¶å…¬é’¥",
                "btnSavePub": "ğŸ’¾ ä¿å­˜å…¬é’¥",
                "sec2Title": "2. æ–‡ä»¶å®‰å…¨è§£å¯†",
                "labelInputPriv": "è¾“å…¥ç§é’¥ (Hex):",
                "phInputPriv": "ç²˜è´´æ‚¨çš„ç§é’¥è¿›è¡Œè§£å¯†...",
                "labelInputFile": "é€‰æ‹©åŠ å¯†æ–‡ä»¶ (.hpke):",
                "btnDec": "å®‰å…¨è§£å¯†å¹¶ä¸‹è½½",
                "sec3Title": "3. åŠ å¯†æ–‡ä»¶ (å‘é€è€…)",
                "labelInputPub": "æ¥æ”¶è€…çš„å…¬é’¥ (Hex):",
                "phInputPub": "åœ¨æ­¤ç²˜è´´æ¥æ”¶è€…çš„å…¬é’¥...",
                "labelOrigFile": "é€‰æ‹©åŸå§‹æ–‡ä»¶:",
                "btnEnc": "åŠ å¯†å¹¶ä¸‹è½½ .hpke æ–‡ä»¶",
                "sec4Title": "4. æ–‡æœ¬æ¶ˆæ¯åŠ å¯†",
                "labelMsgPub": "æ¥æ”¶è€…çš„å…¬é’¥ (Hex):",
                "phMsgPub": "åœ¨æ­¤ç²˜è´´æ¥æ”¶è€…çš„å…¬é’¥...",
                "labelMsgPlain": "åŸå§‹æ¶ˆæ¯:",
                "phMsgPlain": "è¾“å…¥è¦åŠ å¯†çš„æ–‡æœ¬æ¶ˆæ¯...",
                "btnTextEnc": "åŠ å¯†æ–‡æœ¬",
                "labelMsgCipher": "åŠ å¯†ç»“æœ (Base64):",
                "phMsgCipher": "åŠ å¯†åçš„å¯†æ–‡å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...",
                "btnCopyCipher": "ğŸ“„ å¤åˆ¶å¯†æ–‡",
                "sec5Title": "5. æ–‡æœ¬æ¶ˆæ¯è§£å¯†",
                "labelDecPriv": "è¾“å…¥ç§é’¥ (Hex):",
                "phDecPriv": "ç²˜è´´æ‚¨çš„ç§é’¥...",
                "labelMsgInCipher": "åŠ å¯†æ¶ˆæ¯ (Base64):",
                "phMsgInCipher": "ç²˜è´´æ”¶åˆ°çš„åŠ å¯†å¯†æ–‡...",
                "btnTextDec": "è§£å¯†æ–‡æœ¬",
                "labelDecResult": "è§£å¯†ç»“æœ:",
                "phDecResult": "è§£å¯†åçš„æ¶ˆæ¯å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...",
                "btnCopyPlain": "ğŸ“„ å¤åˆ¶åŸæ–‡",
                "alertGenFail": "å¯†é’¥ç”Ÿæˆå¤±è´¥: ",
                "alertCopyFail": "å¤åˆ¶å¤±è´¥",
                "btnCopied": "âœ… å·²å¤åˆ¶",
                "alertEnterKeyMsg": "è¯·è¾“å…¥å…¬é’¥å’Œæ¶ˆæ¯å†…å®¹",
                "alertEncFail": "åŠ å¯†å¤±è´¥: ",
                "alertEnterPrivCipher": "è¯·è¾“å…¥ç§é’¥å’ŒåŠ å¯†å¯†æ–‡",
                "valDecFail": "è§£å¯†å¤±è´¥: å¯†é’¥é”™è¯¯æˆ–å¯†æ–‡æŸå",
                "errProvPrivFile": "è¯·æä¾›ç§é’¥å’ŒåŠ å¯†æ–‡ä»¶",
                "statusProcessing": "æ­£åœ¨å¤„ç†...",
                "statusDecSuccess": "è§£å¯†æˆåŠŸï¼æ–‡ä»¶åï¼š",
                "errDecFail": "è§£å¯†å¤±è´¥ï¼šç§é’¥ä¸åŒ¹é…æˆ–æ–‡ä»¶å·²è¢«ç¯¡æ”¹ã€‚",
                "errProvPubFile": "é”™è¯¯ï¼šè¯·æä¾›å…¬é’¥å’Œæ–‡ä»¶",
                "statusEncProcessing": "æ­£åœ¨è¿›è¡Œ HPKE å®‰å…¨åŠ å¯†...",
                "statusEncSuccess": "åŠ å¯†å®Œæˆï¼æ–‡ä»¶åï¼š",
                "errEncFail": "åŠ å¯†å¤±è´¥ï¼š",
                "toggleBlurTitle": "ç‚¹å‡»æ˜¾ç¤º/éšè—",
                "errModuleLoad": "ç³»ç»Ÿé”™è¯¯: åŠ å¯†æ¨¡å—åŠ è½½å¤±è´¥. (éœ€è¦ iOS 14+)"
            },
            "en": {
                "pageTitle": "ECC/HPKE Encryption Tool - Secure Local Encryption",
                "pageMainHeading": "ECC/HPKE Key Management & Encryption Tool",
                "pageDescription": "Client-side secure file encryption tool using ECC/HPKE (P-256). No server upload, completely offline capable, and open source.",
                "pageKeywords": "ECC, HPKE, Online Encryption, File Decryption, P-256, Browser Encryption, Security Tool, Privacy",
                "securityTitle": "Security Commitment: ",
                "securityText": "All encryption operations are performed locally in your browser (Client-side Only).<br>Your private keys and files are never sent to any server.<br>You can use this tool offline.<br>The source code is fully transparent and can be inspected in the browser developer tools.",
                "installBtn": "ğŸ“² Install App",
                "manualTitle": "ğŸ“Œ How to Use",
                "step1Title": "Step 1: Generate Key Pair",
                "step1Text": "Click 'Generate Key Pair' to get a Private Key (for decryption) and a Public Key (for encryption). Keep your Private Key safe; losing it means losing data permanently.",
                "step2Title": "Step 2: Encrypt File",
                "step2Text": "To send a file, get the recipient's Public Key, paste it into the 'Encrypt File' section, select the file, and generate the .hpke encrypted file.",
                "step3Title": "Step 3: Decrypt File",
                "step3Text": "If you receive a .hpke file, paste your Private Key into the 'Decrypt File' section and upload the file to restore the original.",
                "stepTextTitle": "Text Encryption/Decryption",
                "stepTextDesc": "This tool also supports fast encryption and decryption of plain text messages, following the same process.",
                "tipText": "ğŸ’¡ Tip: Public keys can be shared, but Private keys must be kept secret.",
                "sec1Title": "1. Generate ECC Key Pair (HPKE P-256)",
                "sec1Tip": "Generate secure key pairs locally. Keep your Private Key safe!",
                "genBtn": "Generate Key Pair",
                "privWarning": "<strong>WARNING:</strong> NEVER send your Private Key to anyone! Anyone with your Private Key can decrypt all your files.",
                "labelPriv": "Your Private Key (Keep Secret!):",
                "phPriv": "Click above button to generate...",
                "btnCopyPriv": "ğŸ“„ Copy Private Key",
                "btnSavePriv": "ğŸ’¾ Save Private Key",
                "labelPub": "Your Public Key (Share it):",
                "phPub": "Click above button to generate...",
                "btnCopyPub": "ğŸ“„ Copy Public Key",
                "btnSavePub": "ğŸ’¾ Save Public Key",
                "sec2Title": "2. Decrypt File",
                "labelInputPriv": "Input Private Key (Hex):",
                "phInputPriv": "Paste your private key here...",
                "labelInputFile": "Select Encrypted File (.hpke):",
                "btnDec": "Decrypt & Download",
                "sec3Title": "3. Encrypt File (Sender)",
                "labelInputPub": "Recipient's Public Key (Hex):",
                "phInputPub": "Paste recipient's public key here...",
                "labelOrigFile": "Select Original File:",
                "btnEnc": "Encrypt & Download .hpke",
                "sec4Title": "4. Text Message Encryption",
                "labelMsgPub": "Recipient's Public Key (Hex):",
                "phMsgPub": "Paste recipient's public key here...",
                "labelMsgPlain": "Original Message:",
                "phMsgPlain": "Enter text message to encrypt...",
                "btnTextEnc": "Encrypt Text",
                "labelMsgCipher": "Encryption Result (Base64):",
                "phMsgCipher": "Encrypted text will appear here...",
                "btnCopyCipher": "ğŸ“„ Copy Ciphertext",
                "sec5Title": "5. Text Message Decryption",
                "labelDecPriv": "Input Private Key (Hex):",
                "phDecPriv": "Paste your private key...",
                "labelMsgInCipher": "Encrypted Message (Base64):",
                "phMsgInCipher": "Paste received ciphertext...",
                "btnTextDec": "Decrypt Text",
                "labelDecResult": "Decryption Result:",
                "phDecResult": "Decrypted message will appear here...",
                "btnCopyPlain": "ğŸ“„ Copy Text",
                "alertGenFail": "Key generation failed: ",
                "alertCopyFail": "Copy failed",
                "btnCopied": "âœ… Copied",
                "alertEnterKeyMsg": "Please enter Public Key and Message",
                "alertEncFail": "Encryption failed: ",
                "alertEnterPrivCipher": "Please enter Private Key and Ciphertext",
                "valDecFail": "Decryption failed: Wrong key or corrupted data",
                "errProvPrivFile": "Please provide Private Key and Encrypted File",
                "statusProcessing": "Processing...",
                "statusDecSuccess": "Decryption success! Filename: ",
                "errDecFail": "Decryption failed: Key mismatch or file tampering.",
                "errProvPubFile": "Error: Provide Public Key and File",
                "statusEncProcessing": "Encrypting with HPKE...",
                "statusEncSuccess": "Encryption done! Filename: ",
                "errEncFail": "Encryption failed: ",
                "toggleBlurTitle": "Click to reveal/hide",
                "errModuleLoad": "System Error: Encryption module failed to load. (iOS 14+ required)"
            }
        };

        const t = (key) => {
            const lang = document.documentElement.lang.startsWith('zh') ? 'zh' : 'en';
            return i18nData[lang][key] || key;
        };

        function setLanguage(lang) {
            // Basic fallback
            if (!lang.startsWith('zh')) {
                lang = 'en';
            } else {
                lang = 'zh';
            }

            const data = i18nData[lang];
            document.documentElement.lang = lang === 'zh' ? 'zh-CN' : 'en';
            document.title = data.pageTitle;

            // Update Meta Tags
            const updateMeta = (name, content) => {
                const el = document.querySelector(`meta[name="${name}"]`);
                if (el) el.content = content;
            };
            const updateProp = (prop, content) => {
                const el = document.querySelector(`meta[property="${prop}"]`);
                if (el) el.content = content;
            };

            if (data.pageDescription) {
                updateMeta('description', data.pageDescription);
                updateProp('og:description', data.pageDescription);
                updateProp('twitter:description', data.pageDescription);
            }
            if (data.pageKeywords) {
                updateMeta('keywords', data.pageKeywords);
            }
            if (data.pageTitle) {
                updateProp('og:title', data.pageTitle);
                updateProp('twitter:title', data.pageTitle);
            }

            // Apply text content
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (data[key]) {
                    if (['securityText', 'privWarning', 'errModuleLoad'].includes(key)) {
                        el.innerHTML = data[key];
                    } else {
                        el.innerText = data[key];
                    }
                }
            });

            // Apply placeholders
            document.querySelectorAll('[data-i18n-ph]').forEach(el => {
                const key = el.getAttribute('data-i18n-ph');
                if (data[key]) {
                    el.placeholder = data[key];
                }
            });

            // Apply titles
            document.querySelectorAll('[data-i18n-title]').forEach(el => {
                const key = el.getAttribute('data-i18n-title');
                if (data[key]) {
                    el.title = data[key];
                }
            });
        }

        // Auto-detect
        const userLang = navigator.language || navigator.userLanguage;
        setLanguage(userLang);
        window.setLanguage = setLanguage;

        // --- Helper Functions (Moved to Global for access) ---
        // ç”Ÿæˆæ ‡å‡†çš„ UUID v4
        window.generateUUID = () => {
            if (typeof crypto.randomUUID === 'function') {
                return crypto.randomUUID();
            }
            // å…¼å®¹æ—§ç‰ˆæµè§ˆå™¨ç¯å¢ƒ
            return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        };

        // è¾…åŠ©ï¼šBuffer è½¬ Hex
        window.bufToHex = (buf) => Array.from(new Uint8Array(buf))
            .map(b => b.toString(16).padStart(2, '0')).join('');

        // è¾…åŠ©ï¼šHex è½¬ Buffer
        window.hexToBuf = (hex) => {
            const h = hex.trim().replace(/^0x/, '');
            return new Uint8Array(h.match(/.{1,2}/g).map(byte => parseInt(byte, 16)));
        };

        // è¾…åŠ©ï¼šBase64
        window.bufToBase64 = (buf) => {
            let binary = '';
            const bytes = new Uint8Array(buf);
            const len = bytes.byteLength;
            for (let i = 0; i < len; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        };

        window.base64ToBuf = (str) => {
            const binary_string = atob(str);
            const len = binary_string.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binary_string.charCodeAt(i);
            }
            return bytes;
        };

        window.downloadBlob = (blob, name) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = name;
            a.click();
            URL.revokeObjectURL(url);
        };

        window.showStatus = (box, msg, type) => {
            box.innerText = msg;
            box.className = `status ${type}`;
        };

        window.showModuleError = () => {
            const div = document.createElement('div');
            div.className = 'error';
            div.style.padding = '15px';
            div.style.marginBottom = '15px';
            div.innerHTML = t("errModuleLoad") + "<br>Module loading failed.";
            const container = document.querySelector('.container');
            if (container) container.prepend(div);
        }

        // --- UI Logic: Card Toggling (Global) ---
        // Explicitly attach to window
        window.toggleCard = (card) => {
            if (!card && event) {
                // Try to find target from event if card arg is missing
                card = event.target;
            }
            if (!card) return;

            // å¦‚æœç‚¹å‡»çš„æ˜¯å†…éƒ¨å…ƒç´ ï¼Œå‘ä¸Šå¯»æ‰¾ .card
            if (!card.classList.contains('card')) {
                card = card.closest('.card');
            }
            if (card) {
                card.classList.toggle('collapsed');
            }
        };

        // --- Copy / Save Helper ---
        window.copyToClipboard = async (text, btnId) => {
            if (!text) return;
            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    await navigator.clipboard.writeText(text);
                } else {
                    // Fallback for older iOS
                    const textArea = document.createElement("textarea");
                    textArea.value = text;
                    textArea.style.position = "fixed";  //avoid scrolling to bottom
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    try {
                        document.execCommand('copy');
                    } catch (err) {
                        alert(t('alertCopyFail'));
                        document.body.removeChild(textArea);
                        return;
                    }
                    document.body.removeChild(textArea);
                }

                const btn = document.getElementById(btnId);
                const key = btn.getAttribute('data-i18n');

                if (btn) {
                    btn.innerText = t("btnCopied");
                    setTimeout(() => {
                        if (key) {
                            btn.innerText = t(key);
                        }
                    }, 2000);
                }
            } catch (err) {
                alert(t('alertCopyFail'));
            }
        };

        window.saveStringToFile = (text, filename) => {
            if (!text) return;
            const blob = new Blob([text], { type: 'text/plain' });
            downloadBlob(blob, filename);
        };

        // --- PWA Logic ---
        let deferredPrompt;
        const installBtn = document.getElementById('installBtn');

        if (installBtn) {
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                installBtn.style.display = 'block';
            });

            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    deferredPrompt = null;
                    installBtn.style.display = 'none';
                }
            });
        }

        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./hpke_sw.js')
                .then(() => console.log('Service Worker Registered'))
                .catch(err => console.log("SW Fail", err));
        }

        // --- Logic: Sensitive Data Toggle ---
        document.querySelectorAll('.sensitive-blur').forEach(el => {
            el.addEventListener('click', () => {
                el.classList.toggle('revealed');
            });
        });

        // Bind UI Events
        const bindClick = (id, fn) => {
            const el = document.getElementById(id);
            if (el) el.onclick = fn;
        };

        bindClick('copyPrivBtn', () => copyToClipboard(document.getElementById('outPriv').value, 'copyPrivBtn'));
        bindClick('savePrivBtn', () => saveStringToFile(document.getElementById('outPriv').value, 'private_key.hex'));
        bindClick('copyPubBtn', () => copyToClipboard(document.getElementById('outPub').value, 'copyPubBtn'));
        bindClick('savePubBtn', () => saveStringToFile(document.getElementById('outPub').value, 'public_key.hex'));
        bindClick('copyTextCipherBtn', () => copyToClipboard(document.getElementById('textCipher').value, 'copyTextCipherBtn'));
        bindClick('copyTextPlainBtn', () => copyToClipboard(document.getElementById('textOutputPlain').value, 'copyTextPlainBtn'));


        // Run compatibility check logic
        checkCompatibility();

    </script>

    <script type="module" onerror="window.showModuleError()">
        // --- Module Script: Crypto Logic Only ---
        // import { AeadId, CipherSuite, KdfId, KemId } from "https://esm.sh/hpke-js@1.6.5";
        import { AeadId, CipherSuite, KdfId, KemId } from "./hpke_lib/hpke_js.js";

        // Mark module as loaded
        window.isCryptoModuleLoaded = true;

        // åˆå§‹åŒ– HPKE å¥—ä»¶ (P-256)
        const suite = new CipherSuite({
            kem: KemId.DhkemP256HkdfSha256,
            kdf: KdfId.HkdfSha256,
            aead: AeadId.Aes128Gcm,
        });

        // --- é€»è¾‘ 1ï¼šå¯†é’¥ç”Ÿæˆ ---
        document.getElementById('genBtn').onclick = async () => {
            try {
                // ç”Ÿæˆå¯†é’¥å¯¹
                const kp = await suite.kem.generateKeyPair();

                // ä¿®æ­£ï¼šä½¿ç”¨ serialize æ–¹æ³•å¯¼å‡ºåŸå§‹å­—èŠ‚
                const rawPriv = await suite.kem.serializePrivateKey(kp.privateKey);
                const rawPub = await suite.kem.serializePublicKey(kp.publicKey);

                const rawPrivHex = bufToHex(rawPriv);
                const rawPubHex = bufToHex(rawPub);

                document.getElementById('outPriv').value = rawPrivHex;
                document.getElementById('outPub').value = rawPubHex;
                // Reset blur on new generation
                document.getElementById('outPriv').classList.remove('revealed');

                // è‡ªåŠ¨å¡«å……åˆ°è§£å¯†æ¡†æ–¹ä¾¿æµ‹è¯•
                document.getElementById('decryptPriv').value = rawPrivHex;
                document.getElementById('encryptPub').value = rawPubHex;
                document.getElementById('textDecPriv').value = rawPrivHex;
                document.getElementById('textEncPub').value = rawPubHex;
            } catch (e) {
                alert(t("alertGenFail") + e.message);
            }
        };

        // --- é€»è¾‘ 4: æ–‡æœ¬åŠ å¯† ---
        document.getElementById('textEncBtn').onclick = async () => {
            const pubHex = document.getElementById('textEncPub').value;
            const plainText = document.getElementById('textPlain').value;
            const outputBox = document.getElementById('textCipher');

            if (!pubHex || !plainText) {
                alert(t("alertEnterKeyMsg"));
                return;
            }

            try {
                const recipientPubKey = await suite.kem.deserializePublicKey(hexToBuf(pubHex));
                const encoder = new TextEncoder();
                const payload = encoder.encode(plainText);

                const sender = await suite.createSenderContext({
                    recipientPublicKey: recipientPubKey,
                });
                const ct = await sender.seal(payload);

                // ç»“æ„: [enc 65 bytes] + [ciphertext]
                const finalBuf = new Uint8Array(sender.enc.byteLength + ct.byteLength);
                finalBuf.set(new Uint8Array(sender.enc), 0);
                finalBuf.set(new Uint8Array(ct), sender.enc.byteLength);

                outputBox.value = bufToBase64(finalBuf);
            } catch (e) {
                alert(t("alertEncFail") + e.message);
                console.error(e);
            }
        };

        // --- é€»è¾‘ 5: æ–‡æœ¬è§£å¯† ---
        document.getElementById('textDecBtn').onclick = async () => {
            const privHex = document.getElementById('textDecPriv').value;
            const cipherBase64 = document.getElementById('textInputCipher').value;
            const outputBox = document.getElementById('textOutputPlain');

            if (!privHex || !cipherBase64) {
                alert(t("alertEnterPrivCipher"));
                return;
            }

            try {
                const fullData = base64ToBuf(cipherBase64.trim());

                // æå–: enc (65 bytes)
                const enc = fullData.slice(0, 65);
                const ct = fullData.slice(65);

                const privateKey = await suite.kem.deserializePrivateKey(hexToBuf(privHex), false);

                const recipient = await suite.createRecipientContext({
                    recipientKey: privateKey,
                    enc: enc
                });

                const decryptedPayload = await recipient.open(ct);
                const decoder = new TextDecoder();
                outputBox.value = decoder.decode(decryptedPayload);

            } catch (e) {
                outputBox.value = t("valDecFail");
                console.error(e);
            }
        };

        // --- é€»è¾‘ 2ï¼šè§£å¯† ---
        document.getElementById('decBtn').onclick = async () => {
            const privHex = document.getElementById('decryptPriv').value;
            const fileInput = document.getElementById('fileInput');
            const statusBox = document.getElementById('decStatus');

            if (!privHex || !fileInput.files[0]) {
                showStatus(statusBox, t("errProvPrivFile"), "error");
                return;
            }

            try {
                showStatus(statusBox, t("statusProcessing"), "info");

                const fileData = new Uint8Array(await fileInput.files[0].arrayBuffer());

                // HPKE P-256 çº¦å®šï¼šå‰ 65 å­—èŠ‚æ˜¯å°è£…å¯†é’¥ (enc)
                const enc = fileData.slice(0, 65);
                const ct = fileData.slice(65);

                // å¯¼å…¥ç§é’¥
                const privateKey = await suite.kem.deserializePrivateKey(hexToBuf(privHex), false);

                // åˆ›å»ºæ¥æ”¶è€…ä¸Šä¸‹æ–‡
                const recipient = await suite.createRecipientContext({
                    recipientKey: privateKey,
                    enc: enc
                });

                // è§£å¯†
                const decryptedPayload = new Uint8Array(await recipient.open(ct));

                // è§£æ Payload
                const extLen = decryptedPayload[0];
                const decoder = new TextDecoder();
                const ext = decoder.decode(decryptedPayload.slice(1, 1 + extLen));
                const originalFileData = decryptedPayload.slice(1 + extLen);

                // ä¸‹è½½
                const finalBlob = new Blob([originalFileData]);
                const fileName = generateUUID() + (ext ? "." + ext : "");
                downloadBlob(finalBlob, fileName);

                showStatus(statusBox, `${t("statusDecSuccess")}${fileName}`, "success");
            } catch (e) {
                console.error(e);
                showStatus(statusBox, t("errDecFail"), "error");
            }
        };

        // --- é€»è¾‘ 3ï¼šåŠ å¯† ---
        document.getElementById('encBtn').onclick = async () => {
            const pubHex = document.getElementById('encryptPub').value;
            const fileInput = document.getElementById('encryptFile');
            const statusBox = document.getElementById('encStatus');

            if (!pubHex || !fileInput.files[0]) {
                showStatus(statusBox, t("errProvPubFile"), "error");
                return;
            }

            try {
                showStatus(statusBox, t("statusEncProcessing"), "info");

                // å¯¼å…¥æ¥æ”¶è€…å…¬é’¥
                const recipientPubKey = await suite.kem.deserializePublicKey(hexToBuf(pubHex));

                const file = fileInput.files[0];
                const originalName = file.name;

                // --- å…¼å®¹æ€§æ ¸å¿ƒï¼šç²¾å‡†æå–åç¼€ ---
                const lastDotIndex = originalName.lastIndexOf('.');
                // åªæœ‰å½“ç‚¹å·å­˜åœ¨ä¸”ä¸åœ¨é¦–ä½æ—¶ï¼Œæ‰è®¤ä¸ºæœ‰åç¼€
                const ext = (lastDotIndex > 0) ? originalName.slice(lastDotIndex + 1) : "";

                const fileData = new Uint8Array(await file.arrayBuffer());
                const encoder = new TextEncoder();
                const extBytes = encoder.encode(ext);

                // æ•°æ®åŒ…: [1å­—èŠ‚åç¼€é•¿åº¦] + [åç¼€å­—èŠ‚] + [åŸå§‹æ•°æ®]
                const payload = new Uint8Array(1 + extBytes.length + fileData.length);
                payload[0] = extBytes.length;
                payload.set(extBytes, 1);
                payload.set(fileData, 1 + extBytes.length);

                // æ‰§è¡Œ HPKE Seal (å•æ¬¡åŠ å¯†)
                // å®ƒä¼šè‡ªåŠ¨ç”Ÿæˆä¸´æ—¶å¯†é’¥ enc å’Œå¯†æ–‡ ct
                // A sender encrypts a message with the recipient public key.
                const sender = await suite.createSenderContext({
                    recipientPublicKey: recipientPubKey,
                    // Note: baseNonce is optional
                });
                const ct = await sender.seal(payload);

                // æ‹¼è£…æ–‡ä»¶ï¼šenc(65å­—èŠ‚) + ct
                const finalBlob = new Blob([new Uint8Array(sender.enc), new Uint8Array(ct)]);

                // ä¸‹è½½
                const fileName = generateUUID() + ".hpke";
                downloadBlob(finalBlob, fileName);

                showStatus(statusBox, `${t("statusEncSuccess")}${fileName}`, "success");
            } catch (e) {
                console.error(e);
                showStatus(statusBox, t("alertEncFail") + e.message, "error");
            }
        }
    </script>

</body>

</html>